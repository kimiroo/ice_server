<!DOCTYPE HTML>
<html>
<head>
    <title>python-socketio test</title>
    <script src="https://cdn.jsdelivr.net/npm/socket.io@4.8.1/client-dist/socket.io.min.js" integrity="sha256-sOc1gU+Nz+zWzbinzpWil6fh5fJyeinm9ZAYAdUvoMU=" crossorigin="anonymous"></script>
</head>
<body>
    <div>
        Armed: <span id="armed">Not Loaded</span>
    </div>
    <div>
        PC Client Count: <span id="countPC">Not Loaded</span>
        HA Client Count: <span id="countHA">Not Loaded</span>
        HTML Client Count: <span id="countHTML">Not Loaded</span>
    </div>
    <div>
        PC Clients: <span id="listPC">Not Loaded</span>
        HA Clients: <span id="listHA">Not Loaded</span>
        HTML Clients: <span id="listHTML">Not Loaded</span>
    </div>
    <div>
        <div>
            Events:
        </div>
        <div id="events">

        </div>
    </div>
    <script type="text/javascript" charset="utf-8">

        const elemArmed = document.getElementById('armed');
        const elemCountPC = document.getElementById('countPC');
        const elemCountHA = document.getElementById('countHA');
        const elemCountHTML = document.getElementById('countHTML');
        const elemListPC = document.getElementById('listPC');
        const elemListHA = document.getElementById('listHA');
        const elemListHTML = document.getElementById('listHTML');
        const elemEvents = document.getElementById('events');

        let isArmed = false;
        let clientListPC = [];
        let clientListHA = [];
        let clientListHTML = [];
        let lastEventID = null;

        const socket = io('http://localhost:8080', {
            transports: ['websocket', 'polling'],
            upgrade: true,
            rememberUpgrade: false,
            timeout: 5000,
            forceNew: true
        });

        function handleEvent(event) {
            console.log('Event: ' + event);
            lastEventID = event['id'];
            socket.emit('ack', {'id': event['id']});

            const timestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
            const entry = document.createElement('div');
            entry.textContent = `${timestamp}: ${event['event']} ${event['type']} ${event['source']} ${event['data']}`;

            elemEvents.appendChild(entry);
        }

        function updateScreen() {
            elemArmed.textContent = isArmed ? 'Yes' : 'No';

            elemCountPC.textContent = clientListPC.length;
            elemCountHA.textContent = clientListHA.length;
            elemCountHTML.textContent = clientListHTML.length;

            elemListPC.textContent = clientListPC;
            elemListHA.textContent = clientListHA;
            elemListHTML.textContent = clientListHTML;
        }

        socket.on('connect', () => {
            data = {
                'name': 'TEST_HTML',
                'type': 'html'
            }
            if (lastEventID != null) {
                data['lastEventID'] = lastEventID;
            }
            socket.emit('introduce', data);
        });

        socket.on('event', (data) => {
            handleEvent(data['event']);
        });

        socket.on('event_ignored', (data) => {
            console.log('Event ignored: ' + data);
        });

        socket.on('ping', (data) => {
            socket.emit('get');
        });

        socket.on('get_result', (data) => {
            isArmed = data['isArmed'] == true ? true : false;

            const eventList = data['eventList'];
            const clientList = data['clientList'];
            let newClientListPC = [];
            let newClientListHA = [];
            let newClientListHTML = [];

            clientList.forEach(client => {
                if (client['type'] === 'pc') {
                    newClientListPC.push(client);
                } else if (client['type'] === 'ha') {
                    newClientListHA.push(client);
                } else if (client['type'] === 'html') {
                    newClientListHTML.push(client);
                }
            });
            clientListPC = newClientListPC;
            clientListHA = newClientListHA;
            clientListHTML = newClientListHTML;

            eventList.forEach(event => {
                handleEvent(event);
            });

            socket.emit('pong');

            updateScreen();
        });

        setInterval(() => {
            if (!socket.connected) {
                console.log('connecting');
                socket.connect();
            }
        }, 100);
    </script>
</body>
</html>